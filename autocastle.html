<!DOCTYPE html>
<html>
<style>
    html, body {
      width:  100%;
      height: 100%;
      margin: 0px;
    }
    
</style>

<body>



<p>  Click on the image below to download the map.</p>

<canvas id="card" width="10" height="10"  onclick="download_canvas_png()" > <!--style="position:absolute; width:100%; "-->
Your browser does not support the HTML5 canvas tag.</canvas>



<script>
var canvas = document.getElementById("card");
var ctx = canvas.getContext("2d");

function randomInt(max) {return Math.floor(Math.random() * max);}




//=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
//School Info


//Generate a fake name for the school
hognames = ["Pig","Boar","Onion","Kidney","Grumble","Tumble","Slug","Slime","Swine","Bacon","Pork","Head","Frog","Hair","Snail","Clam","Beef","Dog","Sausage","Wart","Flavor","Grime","Goat","Leech"];
wartnames = ["farts","pus","mites","ticks","slime","wound","meat","cheese","lice","boil","burp","chuck","more","guts","trash","gore","warmer","heap","pile","time","butter","mold","hogs","motte","town","shire","leech"];
schoolname = hognames[randomInt(hognames.length)]+wartnames[randomInt(wartnames.length)];

//generate house names
ravenNames = ["Woofle","Lion","Bird","Ghost","Animal","Dragon","Serpent","Sniffle","Jump","Tumble","Sass","Raisin","Sunny","Sneaker","Tender","Spider","Feather","Giant","Pheonix","Wolf","Horse","Blobfish","Up","Donkey","Flumph","Modron"];
clawNames = ["tuft","grump","in","blow","claw","tooth","hoof","hug","love","fish","up","well","son","more","slayer","fang","bite","swin","mount","flame","roar","wood","flip","fluff","smell"];
housenameS = ravenNames[randomInt(ravenNames.length)]+clawNames[randomInt(clawNames.length)];
housenameC = ravenNames[randomInt(ravenNames.length)]+clawNames[randomInt(clawNames.length)];
housenameH = ravenNames[randomInt(ravenNames.length)]+clawNames[randomInt(clawNames.length)];
housenameD = ravenNames[randomInt(ravenNames.length)]+clawNames[randomInt(clawNames.length)];

//house colors
spadeColor = "#333";
heartColor = "#f00";
diamondColor = "#00f";
clubColor = "#080";
spadeHallColor = "#bbb";
heartHallColor = "#dbb";
diamondHallColor = "#bbd";
clubHallColor = "#aba";


//List of rooms. These don't have positions yet.
//(I used python to generate this javascript syntax, which I find vaguely amusing.)
var baserooms = [
{rank:"2", suit:"♠", hallway:1 , bgcolor:spadeHallColor, title:"Hallway", subtitle:"", symbol:""},
{rank:"2", suit:"♥", hallway:1 , bgcolor:heartHallColor, title:"Hallway", subtitle:"", symbol:""},
{rank:"2", suit:"♦", hallway:1 , bgcolor:diamondHallColor, title:"Hallway", subtitle:"", symbol:""},
{rank:"2", suit:"♣", hallway:1 , bgcolor:clubHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"", suit:"☆", hallway:1 , bgcolor:"#FFD700", title:"Grand Hall", subtitle:"", symbol:""},
  ];

var unplaced_rooms = [
  {rank:"3", suit:"♠", hallway:1 , bgcolor:spadeHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"3", suit:"♥", hallway:1 , bgcolor:heartHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"3", suit:"♦", hallway:1 , bgcolor:diamondHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"3", suit:"♣", hallway:1 , bgcolor:clubHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"4", suit:"♠", hallway:1 , bgcolor:spadeHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"4", suit:"♥", hallway:1 , bgcolor:heartHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"4", suit:"♦", hallway:1 , bgcolor:diamondHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"4", suit:"♣", hallway:1 , bgcolor:clubHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"5", suit:"♠", hallway:1 , bgcolor:spadeHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"5", suit:"♥", hallway:1 , bgcolor:heartHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"5", suit:"♦", hallway:1 , bgcolor:diamondHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"5", suit:"♣", hallway:1 , bgcolor:clubHallColor, title:"Hallway", subtitle:"", symbol:""},
  {rank:"6", suit:"♠", hallway:1 , bgcolor:spadeHallColor, title:"Hallway", subtitle:"Must be in "+housenameS, symbol:""},
  {rank:"6", suit:"♥", hallway:1 , bgcolor:heartHallColor, title:"Hallway", subtitle:"Pitch Black", symbol:"🕯️"},
  {rank:"6", suit:"♦", hallway:1 , bgcolor:diamondHallColor, title:"Hallway", subtitle:"Hidden Door", symbol:""},
  {rank:"6", suit:"♣", hallway:1 , bgcolor:clubHallColor, title:"Hallway", subtitle:"Overgrown", symbol:"🌿"},
  {rank:"7", suit:"♠", hallway:1 , bgcolor:spadeHallColor, title:"Hallway", subtitle:"Shifting Exit", symbol:""},
  {rank:"7", suit:"♥", hallway:1 , bgcolor:heartHallColor, title:"Hallway", subtitle:"Precarious walkways", symbol:""},
  {rank:"7", suit:"♦", hallway:1 , bgcolor:diamondHallColor, title:"Hallway", subtitle:"Riddle", symbol:"?"},
  {rank:"7", suit:"♣", hallway:1 , bgcolor:clubHallColor, title:"Hallway", subtitle:"Guard Beast", symbol:"🐉"},
  {rank:"8", suit:"♠", hallway:0 , bgcolor:spadeColor, title:"Lounge", subtitle:housenameS, symbol:"🛋"},
  {rank:"8", suit:"♥", hallway:0 , bgcolor:heartColor, title:"Lounge", subtitle:housenameH, symbol:"🛋"},
  {rank:"8", suit:"♦", hallway:0 , bgcolor:diamondColor, title:"Lounge", subtitle:housenameD, symbol:"🛋"},
  {rank:"8", suit:"♣", hallway:0 , bgcolor:clubColor, title:"Lounge", subtitle:housenameC, symbol:"🛋"},
  {rank:"9", suit:"♠", hallway:0 , bgcolor:spadeColor, title:"Study Room", subtitle:housenameS, symbol:"🖋"},
  {rank:"9", suit:"♥", hallway:0 , bgcolor:heartColor, title:"Study Room", subtitle:housenameH, symbol:"🖋"},
  {rank:"9", suit:"♦", hallway:0 , bgcolor:diamondColor, title:"Study Room", subtitle:housenameD, symbol:"🖋"},
  {rank:"9", suit:"♣", hallway:0 , bgcolor:clubColor, title:"Study Room", subtitle:housenameC, symbol:"🖋"},
  {rank:"10", suit:"♠", hallway:0 , bgcolor:spadeColor, title:"Classroom", subtitle:"Rhetoric", symbol:"🗣️"},
  {rank:"10", suit:"♥", hallway:0 , bgcolor:heartColor, title:"Classroom", subtitle:"Gymnasium", symbol:"🏋"},
  {rank:"10", suit:"♦", hallway:0 , bgcolor:diamondColor, title:"Classroom", subtitle:"Mathematics", symbol:"🧮"},
  {rank:"10", suit:"♣", hallway:0 , bgcolor:clubColor, title:"Classroom", subtitle:"Languages", symbol:"🗺️"},
  {rank:"J", suit:"♠", hallway:0 , bgcolor:spadeColor, title:"Secret Society", subtitle:"(Secret)", symbol:""},
  {rank:"J", suit:"♥", hallway:0 , bgcolor:heartColor, title:"Vault", subtitle:"(Secret)", symbol:"⚙️"},
  {rank:"J", suit:"♦", hallway:0 , bgcolor:diamondColor, title:"Lost Library", subtitle:"(Secret)", symbol:"📜"},
  {rank:"J", suit:"♣", hallway:0 , bgcolor:clubColor, title:"Exotic Garden", subtitle:"(Secret)", symbol:"🌵"},
  {rank:"Q", suit:"♠", hallway:0 , bgcolor:spadeColor, title:"Classroom", subtitle:"Alchemy", symbol:"⚗️"},
  {rank:"Q", suit:"♥", hallway:0 , bgcolor:heartColor, title:"Dueling Arena", subtitle:"", symbol:"⚔"},
  {rank:"Q", suit:"♦", hallway:0 , bgcolor:diamondColor, title:"Library", subtitle:"", symbol:"📖"},
  {rank:"Q", suit:"♣", hallway:0 , bgcolor:clubColor, title:"Kitchens", subtitle:"", symbol:"🍳"},
  {rank:"K", suit:"♠", hallway:0 , bgcolor:spadeColor, title:"Classroom", subtitle:"Enchantment", symbol:"🧠"},
  {rank:"K", suit:"♥", hallway:0 , bgcolor:heartColor, title:"Classroom", subtitle:"Evocation", symbol:"🔥"},
  {rank:"K", suit:"♦", hallway:0 , bgcolor:diamondColor, title:"Classroom", subtitle:"Divination", symbol:"🔮"},
  {rank:"K", suit:"♣", hallway:0 , bgcolor:clubColor, title:"Classroom", subtitle:"Necromancy", symbol:"⚰️"},
  {rank:"A", suit:"♠", hallway:0 , bgcolor:spadeColor, title:"Dorms", subtitle:housenameS, symbol:"🛏"},
  {rank:"A", suit:"♥", hallway:0 , bgcolor:heartColor, title:"Dorms", subtitle:housenameH, symbol:"🛏"},
  {rank:"A", suit:"♦", hallway:0 , bgcolor:diamondColor, title:"Dorms", subtitle:housenameD, symbol:"🛏"},
  {rank:"A", suit:"♣", hallway:0 , bgcolor:clubColor, title:"Dorms", subtitle:housenameC, symbol:"🛏"},
  {rank:"", suit:"★", hallway:0 , bgcolor:"#FFD700", title:"Headmaster's", subtitle:"Office", symbol:""},
] ;

var castle = {name:schoolname, rooms:[], map: {}, bounds:[[0,0],[0,0]]}




//--------------------------------------------------------------------
//Algorithm to build the castle


function place_room(room, position){
  room.xpos = position[0];
  room.ypos = position[1];
  castle.map[position] = room;
  castle.rooms.push(room);
  if (position[0] > castle.bounds[0][1]){castle.bounds[0][1] = position[0];}
  if (position[0] < castle.bounds[0][0]){castle.bounds[0][0] = position[0];}
  if (position[1] > castle.bounds[1][1]){castle.bounds[1][1] = position[1];}
  if (position[1] < castle.bounds[1][0]){castle.bounds[1][0] = position[1];}
}

//Initialize castle with the basic rooms. Remember that +y is down, -y is up.
place_room(baserooms[4],[0,0]);
place_room(baserooms[0],[0,1]);
place_room(baserooms[1],[1,0]);
place_room(baserooms[2],[0,-1]);
place_room(baserooms[3],[-1,0]);


//fill up the rest of the castle by the following rules:
// * A card may only go in an empty space
// * A card may go horizontally next to a room that shares rank or suit.
// * ★★ may go horizontally next to anything
// * A hallway (ranks 2-7) may go above or below another hallway that share the same rank or suit
// * ny room may go on the ground floor away from the castle as a new building.
//weights are applied to make verticality more common
function find_valid_position(newroom){
  var possiblePos = [];
  for (var i = 0; i < castle.rooms.length; i++){
    var room = castle.rooms[i];
    //Check for horizontal adjacencies
    if ((room.suit == newroom.suit || room.rank == newroom.rank) || room.suit == '★'){
      for(var repeat=0; repeat < 3; repeat++){
        if (!([room.xpos+1,room.ypos] in castle.map)){possiblePos.push([room.xpos+1,room.ypos])}
        if (!([room.xpos-1,room.ypos] in castle.map)){possiblePos.push([room.xpos-1,room.ypos])}
      }
    }
    //Check for vertical hallway adjacencies
    if (room.hallway && newroom.hallway && (room.suit == newroom.suit || room.rank == newroom.rank)){
      for(var repeat=0; repeat < 20; repeat++){
        if (!([room.xpos,room.ypos+1] in castle.map)){possiblePos.push([room.xpos,room.ypos+1])}
        if (!([room.xpos,room.ypos-1] in castle.map)){possiblePos.push([room.xpos,room.ypos-1])}
        if (!([room.xpos,room.ypos-1] in castle.map)){possiblePos.push([room.xpos,room.ypos-1])}
      }
    }
  }
  //add space for extra buildings
  var bounds = castle.bounds;
  possiblePos.push([bounds[0][0]-3,0]);
  possiblePos.push([bounds[0][1]+3,0]);

  return possiblePos[randomInt(possiblePos.length)];
}


//Generate the rest of the castle
while(unplaced_rooms.length > 0 ){
  //pick a card and add it to castle
  var cardindex = randomInt(unplaced_rooms.length);
  var newroom = unplaced_rooms[cardindex];
  var newpos = find_valid_position(newroom);
  place_room(newroom,newpos);
  //remove that card from deck
  unplaced_rooms.splice(cardindex,1);
}

//----------------------------------------------------------------
//Drawing Functions

function drawLine(x1,y1,x2,y2,context) {
  context.moveTo(x1,y1);
  context.lineTo(x2,y2);  
  context.strokeStyle = '#000';
  context.stroke(); 
}

//take in array of coords. fill polygon
function drawPoly(vertices,fillColor,lineColor){
  ctx.fillStyle = fillColor;
  ctx.beginPath();
  for (var i = 0; i < vertices.length; i++) {
    ctx.lineTo(vertices[i][0],vertices[i][1]);
  }
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle = lineColor;
  ctx.stroke(); 
}

function drawRectangle(x1, y1,x2,y2,fillColor,lineColor){
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.rect(x1, y1,x2,y2);
  ctx.fillStyle = fillColor;
  ctx.fill();
  ctx.strokeStyle = lineColor;
  ctx.stroke(); 
}

function draw_room_title_text(text,x,y,s){
  ctx.font = (s/6).toString()+"px Impact";
  ctx.textAlign = "center";
  ctx.textBaseline = 'bottom'; 
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 4;
  ctx.strokeText(text, x, y,s);
  ctx.fillStyle = '#fff';
  ctx.fillText(text,x,y,s);
}

function draw_room_subtitle_text(text,x,y,s){
  ctx.font = (s/8).toString()+"px Impact";
  ctx.textAlign = "center";
  ctx.textBaseline = 'bottom'; 
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 4;
  ctx.strokeText(text, x, y,s);
  ctx.fillStyle = '#fff';
  ctx.fillText(text,x,y,s);
}

function draw_room_card_text(text,x,y,s){
  ctx.font = (s/5).toString()+"px Impact";
  ctx.textAlign = "left";
  ctx.textBaseline = 'bottom'; 
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 4;
  ctx.strokeText(text, x, y,s);
  ctx.fillStyle = '#fff';
  ctx.fillText(text,x,y,s);
}

function draw_room_symbol_text(text,x,y,s){
  ctx.font = (s*0.4).toString()+"px serif";
  ctx.textAlign = "center";
  ctx.textBaseline = 'middle'; 
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 4;
  ctx.strokeText(text, x, y,s);
  ctx.fillStyle = '#fff';
  ctx.fillText(text,x,y,s);
}

//==========================================================
//TODO functionalize text label, add title and emoji symbol to each room, clean up old objects



function drawCastle(originx,originy,squaresize){
  for (var i = 0; i < castle.rooms.length; i++){
    var room = castle.rooms[i];
    var roomx = room.xpos*squaresize + originx;
    var roomy = room.ypos*squaresize + originy;

    drawRectangle(roomx,roomy,squaresize,-squaresize,room.bgcolor,'#000');

    //label text for each room
    suit_fix = {"♠":"\u2660", "♥":"\u2665", "♦":"\u2666", "♣":"\u2663", "★":"\u2605", "☆":"\u2606"}; //wasn't rendering in blogger without this. No idea why
    draw_room_card_text(suit_fix[room.suit] + room.rank,roomx+squaresize/50,roomy-squaresize/50,squaresize*0.95);

    draw_room_subtitle_text(room.subtitle,roomx+squaresize/2,roomy-squaresize*0.68,squaresize*0.95);
    draw_room_title_text(room.title,roomx+squaresize/2,roomy-squaresize*0.8,squaresize*0.95);
    draw_room_symbol_text(room.symbol,roomx+squaresize/2,roomy-squaresize*0.3,squaresize);

  }
}



function genCastleMap(){
  //refresh canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  //detect the best possible size for the canvas
  var bounds = castle.bounds;
  var squaresize = 150;
  ctx.canvas.width  = squaresize*2*Math.max(bounds[0][1]+2,-bounds[0][0]+2);
  ctx.canvas.height = squaresize*2*Math.max(bounds[1][1]+1,-bounds[1][0]+3);
  //ctx.canvas.width  = 2*window.innerWidth;
  //ctx.canvas.height = 2*window.innerHeight;
  //canvas.css("height", "600px");
  //canvas.css("width","600px");

  //draw background
  drawRectangle(0, 0, canvas.width, canvas.height,'#aaf','#0000');
  //draw ground
  drawRectangle(0, canvas.height/2.0, canvas.width, canvas.height,'#8a8','#000');

  //figure out where to place the castle
  var castleYorigin = canvas.height/2;
  var castleXorigin = canvas.width/2 - squaresize/2;

  drawCastle(castleXorigin,castleYorigin,squaresize);
 }


genCastleMap();




function download_canvas_png(){

  var link = document.createElement('a');
  link.download = schoolname+"SchoolMap.png";
  link.target="_blank"
  link.href = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");;
  link.click();
}
</script>

//can i change the image name here?

<!--<img id="canvasimg" src="" name="horsemeat,png" style="position:absolute; width:600px;"/>
<script type="text/javascript">
$("#canvasimg").attr("src", $("#card").get(0).toDataURL("img/png"));
</script>-->

</body>
</html>
